package cn.com.navia.PhoneService.server.web;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import cn.com.navia.PhoneService.assist.ShaUtil;
import cn.com.navia.PhoneService.bean.BeanInit;
import cn.com.navia.PhoneService.bean.RespHub;
import cn.com.navia.PhoneService.dao.HubDao;



@RestController
@RequestMapping("/TrHub")
public class HubInitController {

	@Resource
	private HubDao hubDao;

	@Value("${trhub.api.baseurl}")
	private String apiBaseUrl;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

	@Value("${trhub.latest.version}")
	private String latestVersion;

	@Value("${trhub.latest.apkurl}")
	private String apkUrl;

	private Logger log = LoggerFactory.getLogger(this.getClass());
	private static String apiV0path = "/V0";

	@RequestMapping(value = "/init", produces = MediaType.APPLICATION_JSON_VALUE + "; charset=UTF-8")
	public RespHub getToken(HttpServletRequest request, @RequestParam(value = "ver") String appVer,
			@RequestParam(value = "mac", defaultValue = "0") String phoneMac,
			@RequestParam(value = "idfv", defaultValue = "0") String idFV) {
		if ((appVer.length() == 0) || (phoneMac.length() + idFV.length() == 2))
			return new RespHub((byte) -1, "参数错误！");
		byte osType = 0;														//1-Android, 2-iOS
		byte force = 0;
		if (idFV.length() == 36){
			osType = 2;
			idFV = idFV.toUpperCase();
			phoneMac = "";
		}
		else if (phoneMac.length() == 17){
			osType = 1;
			phoneMac = phoneMac.toUpperCase();
			idFV = "";
		}
		else
			return new RespHub((byte) -1, "参数错误！");

		String tokenTime = String.valueOf(System.currentTimeMillis());
		String message = (osType == 1) ? phoneMac : idFV;
		String token = null;
		message = tokenTime + message + tokenTime + "cn.com.navia.PhoneService";
		try {
			token = ShaUtil.tokenDigest(message);
			if ( ! hubDao.saveInitData(phoneMac, idFV, osType, appVer, token))
				return new RespHub((byte) -2, "init保存数据失败！");
		} catch (Exception e) {
			log.error("HubInitController error: {}", e.getMessage());
			return new RespHub((byte) -9, "Exception异常！");
		}

		return new RespHub((byte) 0, "Init成功！", new BeanInit(token, apiBaseUrl + apiV0path, latestVersion, apkUrl, force));
	}


	@ExceptionHandler(Exception.class)
	public String handleException(HttpServletRequest req, Exception e) {
		log.error("HubControllerV0 Exception from {}, RequestURI: {}, Message: {}",
				req.getRemoteAddr(), req.getRequestURI(), e.getMessage());

		return null;
	} 

}
